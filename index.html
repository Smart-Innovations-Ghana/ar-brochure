<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #status {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px;
        z-index: 10000;
        font-family: Arial;
      }
    </style>
  </head>
  <body>
    <div id="status">Initializing...</div>

    <!-- Videos outside the scene (more reliable) -->
    <!-- Galamsey Video -->
    <video
      id="vid0"
      src="./assets/videos/galamsey.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Excavator Suite (How it works) -->
    <video
      id="vid1"
      src="./assets/videos/excavator-suite.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Control Room -->
    <video
      id="vid2"
      src="./assets/videos/contol-room.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Spatial Detection -->
    <video
      id="vid3"
      src="./assets/videos/drone-fottage.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Product Demo -->
    <video
      id="vid4"
      src="./assets/videos/explosives-truck.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Load Scanner -->
    <video
      id="vid5"
      src="./assets/videos/load-scanner.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>
    <!-- Goldbod -->
    <video
      id="vid6"
      src="./assets/videos/goldbod.mp4"
      preload="auto"
      loop
      muted
      style="display: none"
    ></video>

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; autoStart: true; maxTrack: 4;"
      vr-mode-ui="enabled: false"
    >
      <a-camera
        active="true"
        position="0 0 0"
        look-controls="enabled: false"
      ></a-camera>

      <!-- TARGET 0: Galamsey Video -->
      <a-entity
        mindar-image-target="targetIndex: 0"
        class="target-entity"
        data-target-index="0"
      >
        <a-video
          src="#vid0"
          position="0 0 0.1"
          width="1"
          height="0.5625"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      </a-entity>

      <!-- Target 1: Excavator Suite (How it wroks) -->
      <a-entity
        mindar-image-target="targetIndex: 1"
        class="target-entity"
        data-target-index="1"
      >
        <a-video
          src="#vid1"
          position="0 0 0.1"
          width="1"
          height="1.066"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      </a-entity>

      <!-- TARGET 2: Control Room Video -->
      <a-entity
        mindar-image-target="targetIndex: 2"
        class="target-entity"
        data-target-index="2"
      >
        <a-video
          src="#vid2"
          position="0 0 0.1"
          width="1"
          height="1.066"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      </a-entity>

      <!-- TARGET 3: Drone Footage Video -->
      <a-entity
        mindar-image-target="targetIndex: 3"
        class="target-entity"
        data-target-index="3"
      >
        <a-video
          src="#vid3"
          position="0 0 0.1"
          width="1"
          height="0.5625"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      </a-entity>

      <!-- TARGET 4: Excavator Suite Video -->
      <a-entity
        mindar-image-target="targetIndex: 4"
        class="target-entity"
        data-target-index="4"
      >
        <a-video
          src="#vid4"
          position="0 0 0.1"
          width="1"
          height="0.5625"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      </a-entity>

      <!-- Load Scanner -->
      <a-entity
        mindar-image-target="targetIndex: 5"
        class="target-entity"
        data-target-index="5"
      >
        <a-video
          src="#vid5"
          position="0 0 0.1"
          width="1"
          height="1.066"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
      <!-- Goldbod -->
      <a-entity
        mindar-image-target="targetIndex: 6"
        class="target-entity"
        data-target-index="1"
      >
        <a-video
          src="#vid6"
          position="0 0 0.1"
          width="1"
          height="1.066"
          rotation="0 0 0"
          material="shader: flat;"
          visible="false"
        ></a-video>
    </a-scene>

    <script>
      const scene = document.querySelector("a-scene");
      const status = document.getElementById("status");
      const activeTargets = new Set();

      // Safe event handling with error checking
      scene.addEventListener("targetFound", (event) => {
        try {
          // Method 1: Try to get targetIndex from event detail
          let targetIndex = event.detail?.targetIndex;

          // Method 2: If detail is null, get from the target entity
          if (targetIndex === undefined || targetIndex === null) {
            const targetEntity = event.target;
            targetIndex = targetEntity.getAttribute("data-target-index");
          }

          // Method 3: Last resort - parse from component
          if (targetIndex === undefined || targetIndex === null) {
            const targetComponent =
              event.target.components["mindar-image-target"];
            if (targetComponent) {
              targetIndex = targetComponent.targetIndex;
            }
          }

          if (targetIndex !== undefined && targetIndex !== null) {
            targetIndex = parseInt(targetIndex);
            activeTargets.add(targetIndex);

            // Show and play video
            const targetEntity = event.target;
            const videoElement = targetEntity.querySelector("a-video");
            const videoSource = document.getElementById(`vid${targetIndex}`);

            if (videoElement && videoSource) {
              videoElement.setAttribute("visible", true);
              videoSource.play().catch((error) => {
                console.log(`Video ${targetIndex} play failed:`, error);
              });
            }

            updateStatus();
          } else {
            console.warn("Could not determine target index from event:", event);
          }
        } catch (error) {
          console.error("Error in targetFound event:", error);
        }
      });

      scene.addEventListener("targetLost", (event) => {
        try {
          let targetIndex = event.detail?.targetIndex;

          if (targetIndex === undefined || targetIndex === null) {
            const targetEntity = event.target;
            targetIndex = targetEntity.getAttribute("data-target-index");
          }

          if (targetIndex === undefined || targetIndex === null) {
            const targetComponent =
              event.target.components["mindar-image-target"];
            if (targetComponent) {
              targetIndex = targetComponent.targetIndex;
            }
          }

          if (targetIndex !== undefined && targetIndex !== null) {
            targetIndex = parseInt(targetIndex);
            activeTargets.delete(targetIndex);

            // Hide and pause video
            const targetEntity = event.target;
            const videoElement = targetEntity.querySelector("a-video");
            const videoSource = document.getElementById(`vid${targetIndex}`);

            if (videoElement && videoSource) {
              videoElement.setAttribute("visible", false);
              videoSource.pause();
              videoSource.currentTime = 0;
            }

            updateStatus();
          }
        } catch (error) {
          console.error("Error in targetLost event:", error);
        }
      });

      scene.addEventListener("arReady", () => {
        status.textContent = "âœ… AR Ready - Point camera at target";
      });

      function updateStatus() {
        if (activeTargets.size === 0) {
          status.textContent = "ðŸ” Point camera at any target image";
          status.style.background = "rgba(0, 0, 0, 0.8)";
        } else {
          const targets = Array.from(activeTargets)
            .map((t) => t + 1)
            .join(", ");
          status.textContent = `ðŸŽ¯ Tracking target(s): ${targets}`;
          status.style.background = "green";
        }
      }

      // Alternative: Use component-based approach (more reliable)
      document.addEventListener("DOMContentLoaded", function () {
        // Add click handler for iOS autoplay
        document.body.addEventListener(
          "click",
          function () {
            // This helps with iOS autoplay restrictions
            const videos = document.querySelectorAll("video");
            videos.forEach((video) => {
              video
                .play()
                .catch((e) =>
                  console.log("Pre-play attempt failed (normal):", e)
                );
            });
          },
          { once: true }
        );
      });
    </script>
  </body>
</html>
